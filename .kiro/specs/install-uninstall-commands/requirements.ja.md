# 要件定義書

## はじめに

Claude Code Package Managerは現在、リポジトリの登録、更新、削除の操作を管理しています。しかし、初回セットアップのための専用インストールコマンドや、デプロイされたファイルを選択的にアンインストールするコマンドが不足しています。この機能では、開発者に馴染みのあるコマンドパターンを採用した2つの新しいコマンドを導入します：

1. **install** - repositories.jsonに記載されたすべての依存関係をインストール
2. **uninstall** - 設定を保持したまま、デプロイされたファイルを削除

これらのコマンドにより、開発者が既に理解しているコマンドパターンを活用しながら、将来の再インストールのためにリポジトリ設定を保持する柔軟性を維持します。

## 要件

### 要件1: インストールコマンド（依存関係の一括インストール）

**ユーザーストーリー:** 開発者として、`ccpm install`を実行してrepositories.jsonからすべての依存関係をインストールしたい。これにより、使い慣れたパターンで環境をセットアップできる。

#### 受け入れ基準

1. ユーザーが引数なしで`ccpm install`を実行した場合、システムはrepositories.jsonを読み込み、記載されているすべてのリポジトリをインストールする。

2. ユーザーが`ccpm install <repository-url>`を実行した場合、システムはリポジトリを登録し、即座にインストールする。

3. `ccpm install`を実行し、repositories.jsonが存在する場合、システムは未クローンのリポジトリをクローンし、ファイルを~/.claudeにデプロイする。

4. インストールコマンドがリポジトリのインストール中にエラーに遭遇した場合、システムは他のリポジトリの処理を継続し、最後に失敗の概要を表示する。

5. ユーザーが`ccpm install --save <repository-url>`を実行した場合、システムはリポジトリをインストールし、repositories.jsonに追加する。

6. インストールコマンドが正常に完了した場合、システムはインストール統計を表示する（例：「3個のパッケージを1.337秒で追加しました」）。

7. ユーザーが`ccpm install`を実行し、すべてのリポジトリが既に最新の場合、システムは「すべて最新です（X秒）」と表示する。

8. インストールコマンドの実行中、システムは各リポジトリの処理についてプログレスバーまたはスピナーを表示する。

### 要件2: アンインストールコマンド（選択的なパッケージ削除）

**ユーザーストーリー:** 開発者として、`ccpm uninstall`を使用して、オプションで設定を保持しながらパッケージを削除したい。これにより、使い慣れたパターンで環境を管理できる。

#### 受け入れ基準

1. ユーザーが`ccpm uninstall <repository-name>`を実行した場合、システムはデプロイされたファイルとリポジトリ登録の両方を削除する。

2. ユーザーが`ccpm uninstall <repository-name> --no-save`を実行した場合、システムはデプロイされたファイルのみを削除し、リポジトリをrepositories.jsonに保持する。

3. ユーザーが引数なしで`ccpm uninstall`を実行した場合、システムはリポジトリ名を要求するエラーメッセージを表示する。

4. デプロイされたファイルがローカルで変更されている場合、システムは削除をスキップし、ユーザーに警告する（ユーザーの変更を保護）。

5. ユーザーが`ccpm uninstall <repository-name> --force`を実行した場合、システムは変更されたファイルを含むすべてのファイルを削除する。

6. アンインストールコマンドが完了した場合、システムは「X個のパッケージをY秒で削除しました」と表示する。

7. 指定されたリポジトリが見つからない場合、システムは「エラー: リポジトリが見つかりません」というエラーメッセージを表示する。

8. ユーザーが`ccpm uninstall --save <repository-name>`を実行した場合、システムはファイルを削除し、repositories.jsonを更新する（明示的な保存動作）。

### 要件3: 状態管理と追跡

**ユーザーストーリー:** システム管理者として、インストールとアンインストールの正確な記録を維持してもらい、何がデプロイされているかを追跡し、問題をトラブルシューティングできるようにしたい。

#### 受け入れ基準

1. インストールコマンドを介してファイルがデプロイされた場合、システムはstate.jsonにソース、ターゲット、ハッシュ、タイムスタンプを含むデプロイメントの詳細を記録する。

2. アンインストールコマンドを介してファイルが削除された場合、システムはstate.jsonを更新してデプロイメントレコードを削除する。

3. state.jsonが破損または欠落している場合、システムはファイルシステムをスキャンし、登録されたリポジトリと照合して再構築を試みる。

4. ユーザーがインストールまたはアンインストール後に`ccpm status`を実行した場合、システムは現在のデプロイメント状態を正確に反映する。

5. デプロイメント追跡に関して、システムは各リポジトリの個別のインストールステータスを維持する。

6. リポジトリがアンインストールされた場合、システムはリポジトリのメタデータを保持するが、デプロイメント情報をクリアする。

### 要件4: エラー処理とリカバリ

**ユーザーストーリー:** ユーザーとして、インストールとアンインストール中にシステムがエラーを適切に処理し、部分的な失敗が環境を不整合な状態にしないようにしたい。

#### 受け入れ基準

1. インストールコマンドが途中で失敗した場合、システムは潜在的なロールバックのために正常にデプロイされたファイルの記録を維持する。

2. インストールコマンドがファイルの競合に遭遇した場合、システムは設定された競合解決戦略（スキップ/上書き/プロンプト）に従う。

3. アンインストールコマンドが権限のためにファイルを削除できない場合、システムはエラーをログに記録し、他のファイルの処理を継続する。

4. いずれかのコマンドが重大なエラーに遭遇した場合、システムは推奨される修復手順を含む明確なエラーメッセージを提供する。

5. システムがstate.jsonと実際のデプロイされたファイルの間の不整合を検出した場合、システムは差異を調整することを提案する。

6. ユーザーが`ccpm install --force`を実行した場合、システムはすべてのパッケージを再インストールし、ローカルの変更を上書きする。

### 要件5: ユーザーエクスペリエンスと分かりやすい出力

**ユーザーストーリー:** 開発者として、ccpmが分かりやすい出力パターンとコマンド動作を提供し、既存の知識とスクリプトを使用できるようにしたい。

#### 受け入れ基準

1. インストール操作の進行中、システムは明確な進行状況インジケーターを表示する（例：「リポジトリをインストール中... [2/5]」）。

2. 操作が完了した場合、システムは簡潔な要約を表示する（例：「3個のパッケージを追加、2個のパッケージを削除しました（1.337秒）」）。

3. ユーザーが`ccpm install --silent`を実行した場合、システムはエラー以外のすべての出力を抑制する。

4. ユーザーが`ccpm install --verbose`を実行した場合、システムは詳細なログを明確な接頭辞付きで表示する。

5. エラーが発生した場合、システムは明確なエラーメッセージを表示する（例：「エラー: ファイルが見つかりません（ENOENT）」）。

6. ユーザーが`ccpm install --json`を実行した場合、システムはスクリプト用にJSON形式でインストール結果を出力する。