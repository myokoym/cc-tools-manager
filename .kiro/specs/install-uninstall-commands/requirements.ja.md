# 要件定義書

## はじめに

Claude Code Package Managerは現在、`remove`コマンドでリポジトリの登録解除とファイル削除の両方を処理しています。より明確な責任分離と直感的なコマンドペアを提供するため、この機能ではコマンド体系を再構築します：

**現在の構造:**
- `register` - リポジトリを登録
- `remove` - リポジトリの登録解除とファイル削除（オプションで保持可能）
- `update` - 変更をプルし、オプションでデプロイ

**新しい構造:**
- `register`/`unregister` - リポジトリ登録の管理
- `install`/`uninstall` - ファイルデプロイの管理
- `update` - 変更をプルし、オプションでデプロイ（変更なし）

この分離により、より明確なセマンティクスを提供します：登録は追跡するリポジトリを管理し、インストールはデプロイするファイルを管理します。

## 要件

### 要件1: インストールコマンド（登録済みリポジトリのデプロイ）

**ユーザーストーリー:** 開発者として、`ccpm install`を実行して登録済みのすべてのリポジトリからファイルをデプロイしたい。これにより、登録したツールでClaude環境をセットアップできる。

#### 受け入れ基準

1. ユーザーが引数なしで`ccpm install`を実行した場合、システムは登録済みのすべてのリポジトリから~/.claudeにファイルをデプロイする。

2. ユーザーが`ccpm install <repository-name>`を実行した場合、システムは指定されたリポジトリからのみファイルをデプロイする。

3. リポジトリがローカルにクローンされていない場合、システムはファイルをデプロイする前にまずクローンする。

4. インストールコマンドがデプロイ中にエラーに遭遇した場合、システムは他のリポジトリの処理を継続し、最後に失敗の概要を表示する。

5. ユーザーが`ccpm install --force`を実行した場合、システムはプロンプトなしで既存のファイルを上書きする。

6. インストールコマンドが正常に完了した場合、システムはデプロイ統計を表示する（例：「3個のリポジトリから15個のファイルをデプロイしました」）。

7. ユーザーが`ccpm install`を実行し、すべてのファイルが既にデプロイ済みの場合、システムは「すべてのファイルが最新です」と表示する。

8. インストールコマンドの実行中、システムは各リポジトリの処理の進行状況を表示する。

### 要件2: アンインストールコマンド（デプロイされたファイルの削除）

**ユーザーストーリー:** 開発者として、`ccpm uninstall`を使用してデプロイされたファイルを削除し、リポジトリ登録は保持したい。これにより、リポジトリ設定を失うことなく環境をクリーンアップできる。

#### 受け入れ基準

1. ユーザーが`ccpm uninstall <repository-name>`を実行した場合、システムはデプロイされたファイルのみを削除し、リポジトリ登録は保持する。

2. ユーザーが引数なしで`ccpm uninstall`を実行した場合、システムはすべてのリポジトリからすべてのデプロイされたファイルを削除する。

3. デプロイされたファイルがローカルで変更されている場合、システムは削除をスキップし、ユーザーに警告する（ユーザーの変更を保護）。

4. ユーザーが`ccpm uninstall <repository-name> --force`を実行した場合、システムは変更されたファイルを含むすべてのファイルを削除する。

5. アンインストールコマンドが完了した場合、システムは「Y個のリポジトリからX個のファイルを削除しました」と表示する。

6. 指定されたリポジトリが見つからない場合、システムは「エラー: リポジトリが見つかりません」というエラーメッセージを表示する。

7. ユーザーが`ccpm uninstall --dry-run`を実行した場合、システムは実際にファイルを削除せずに何が削除されるかを表示する。

8. アンインストール完了後、システムはstate.jsonを更新して削除されたデプロイメントを反映する。

### 要件3: 登録解除コマンド（リポジトリ登録の削除）

**ユーザーストーリー:** 開発者として、`ccpm unregister`を使用して、登録とデプロイされたファイルを含むリポジトリを完全に削除したい。これにより、不要になったリポジトリを完全にクリーンアップできる。

#### 受け入れ基準

1. ユーザーが`ccpm unregister <repository-name>`を実行した場合、システムはリポジトリ登録とすべてのデプロイされたファイルを削除する。

2. ユーザーが`ccpm unregister <repository-name> --keep-files`を実行した場合、システムは登録のみを削除し、デプロイされたファイルは保持する。

3. ユーザーが引数なしで`ccpm unregister`を実行した場合、システムはリポジトリ名を要求するエラーメッセージを表示する。

4. リポジトリにデプロイされたファイルがある場合、システムは警告を表示し、--forceが使用されていない限り確認を要求する。

5. 登録解除コマンドが完了した場合、システムは削除されたものの概要を表示する。

6. 指定されたリポジトリが見つからない場合、システムは「エラー: リポジトリが登録されていません」というエラーメッセージを表示する。

7. ユーザーが`ccpm unregister --dry-run <repository-name>`を実行した場合、システムは実際に削除せずに何が削除されるかを表示する。

8. 登録解除完了後、システムはrepositories.jsonからリポジトリを削除し、state.jsonをクリーンアップする。

### 要件4: 状態管理と追跡

**ユーザーストーリー:** システム管理者として、インストールとアンインストールの正確な記録を維持してもらい、何がデプロイされているかを追跡し、問題をトラブルシューティングできるようにしたい。

#### 受け入れ基準

1. インストールコマンドを介してファイルがデプロイされた場合、システムはstate.jsonにソース、ターゲット、ハッシュ、タイムスタンプを含むデプロイメントの詳細を記録する。

2. アンインストールコマンドを介してファイルが削除された場合、システムはstate.jsonを更新してデプロイメントレコードを削除する。

3. state.jsonが破損または欠落している場合、システムはファイルシステムをスキャンし、登録されたリポジトリと照合して再構築を試みる。

4. ユーザーがインストールまたはアンインストール後に`ccpm status`を実行した場合、システムは現在のデプロイメント状態を正確に反映する。

5. デプロイメント追跡に関して、システムは各リポジトリの個別のインストールステータスを維持する。

6. リポジトリがアンインストールされた場合、システムはリポジトリのメタデータを保持するが、デプロイメント情報をクリアする。

### 要件5: エラー処理とリカバリ

**ユーザーストーリー:** ユーザーとして、インストールとアンインストール中にシステムがエラーを適切に処理し、部分的な失敗が環境を不整合な状態にしないようにしたい。

#### 受け入れ基準

1. インストールコマンドが途中で失敗した場合、システムは潜在的なロールバックのために正常にデプロイされたファイルの記録を維持する。

2. インストールコマンドがファイルの競合に遭遇した場合、システムは設定された競合解決戦略（スキップ/上書き/プロンプト）に従う。

3. アンインストールコマンドが権限のためにファイルを削除できない場合、システムはエラーをログに記録し、他のファイルの処理を継続する。

4. いずれかのコマンドが重大なエラーに遭遇した場合、システムは推奨される修復手順を含む明確なエラーメッセージを提供する。

5. システムがstate.jsonと実際のデプロイされたファイルの間の不整合を検出した場合、システムは差異を調整することを提案する。

6. ユーザーが`ccpm install --force`を実行した場合、システムはすべてのパッケージを再インストールし、ローカルの変更を上書きする。

### 要件6: ユーザーエクスペリエンスと分かりやすい出力

**ユーザーストーリー:** 開発者として、ccpmが分かりやすい出力パターンとコマンド動作を提供し、既存の知識とスクリプトを使用できるようにしたい。

#### 受け入れ基準

1. インストール操作の進行中、システムは明確な進行状況インジケーターを表示する（例：「リポジトリをインストール中... [2/5]」）。

2. 操作が完了した場合、システムは簡潔な要約を表示する（例：「3個のパッケージを追加、2個のパッケージを削除しました（1.337秒）」）。

3. ユーザーが`ccpm install --silent`を実行した場合、システムはエラー以外のすべての出力を抑制する。

4. ユーザーが`ccpm install --verbose`を実行した場合、システムは詳細なログを明確な接頭辞付きで表示する。

5. エラーが発生した場合、システムは明確なエラーメッセージを表示する（例：「エラー: ファイルが見つかりません（ENOENT）」）。

6. ユーザーが`ccpm install --json`を実行した場合、システムはスクリプト用にJSON形式でインストール結果を出力する。

### 要件7: コマンド移行

**ユーザーストーリー:** 既存のユーザーとして、古い`remove`コマンドから新しい`unregister`コマンドへの移行時に明確なガイダンスが欲しい。これにより、新しいコマンド構造にスムーズに適応できる。

#### 受け入れ基準

1. ユーザーが`ccpm remove`を実行した場合、システムは代わりに`ccpm unregister`を提案する非推奨通知を表示する。

2. ユーザーが`ccpm remove --keep-files`を実行した場合、システムはデプロイされたファイルのみを削除するために`ccpm uninstall`の使用を提案する。

3. 非推奨通知を表示する際、システムは下位互換性のためにremoveコマンドを実行する。

4. ユーザーが`ccpm help`を実行した場合、システムは明確な指標と共に新旧両方のコマンドを表示する。

5. ドキュメントが更新される場合、システムはコマンドの変更を説明する移行ガイドを含める。

6. 猶予期間後、システムは将来のメジャーバージョンで非推奨の`remove`コマンドを削除する。